<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Anah Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script type="module"
    src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
  </script>

  <style>
    :root{
      --bg:#eef1f5; --card:#ffffff; --txt:#0f172a; --muted:#64748b;
      --brand:#1d4ed8; --danger:#b00020;
      --shadow:0 14px 40px rgba(0,0,0,.12);
    }

    html,body{
      margin:0;height:100%;
      background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Arial
    }

    .wrap{
      position:fixed;inset:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:12px;padding:14px
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      background:rgba(255,255,255,.8);
      backdrop-filter:blur(10px);
      border:1px solid rgba(226,232,240,.8);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow)
    }

    .title{display:flex;flex-direction:column;gap:2px}
    .title b{font-size:14px;color:var(--txt)}
    .title span{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:8px;flex-wrap:wrap}

    button{
      border:0;border-radius:12px;
      padding:10px 12px;
      cursor:pointer;font-weight:700;
      background:var(--brand);color:#fff;
      box-shadow:0 10px 26px rgba(29,78,216,.28)
    }
    button.secondary{background:#0f172a}
    button.ghost{
      background:#fff;color:var(--txt);
      border:1px solid #e2e8f0;box-shadow:none
    }

    .stage{
      position:relative;overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(226,232,240,.9);
      background:linear-gradient(180deg,#f8fafc,#eef2ff);
      box-shadow:var(--shadow)
    }

    model-viewer{
      width:100%;height:100%;
      --progress-bar-color: rgba(29,78,216,.95);
      --poster-color: transparent;
    }

    .hud{
      position:absolute;left:50%;top:14px;
      transform:translateX(-50%);
      z-index:20;
      display:flex;gap:10px;
      background:rgba(0,0,0,.7);color:#fff;
      padding:10px 12px;border-radius:12px
    }

    .bar{
      width:220px;height:8px;
      background:rgba(255,255,255,.22);
      border-radius:999px;overflow:hidden
    }
    .bar div{height:100%;width:0%;background:#7dd3fc}

    .hint{
      position:absolute;left:14px;bottom:14px;
      background:rgba(255,255,255,.92);
      border-radius:14px;padding:10px 12px;
      font-size:13px;box-shadow:var(--shadow)
    }

    .k{
      background:#f1f5f9;
      border-radius:10px;
      padding:2px 8px;font-weight:700
    }

    .err{
      display:none;margin-top:8px;
      border:1px solid #fecaca;
      border-radius:14px;padding:10px
    }

    .footer{
      display:flex;justify-content:space-between;
      font-size:12px;color:var(--muted)
    }

    a{color:var(--brand);font-weight:700;text-decoration:none}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="title">
      <b>التوأم الرقمي — مدينة عنه</b>
      <span id="sub">جاهز للتحميل…</span>
    </div>
    <div class="actions">
      <button class="ghost" id="btnAuto">Auto-Fit</button>
      <button class="ghost" id="btnHotspots">Hotspots</button>
      <button class="secondary" id="btnReset">⟳ Reset</button>
    </div>
  </div>

  <div class="stage">
    <div class="hud" id="hud">
      <span id="hudText">⏳ Loading model…</span>
      <div class="bar"><div id="pbar"></div></div>
    </div>

    <model-viewer
      id="mv"
      src=""
      camera-controls
      touch-action="pan-y"
      exposure="1.05"
      shadow-intensity="0.35"
      shadow-softness="0.7"
      environment-image="neutral"
      interaction-prompt="none"
      min-camera-orbit="auto auto 1m"
      max-camera-orbit="auto auto 1200m"
      camera-orbit="45deg 65deg 30m"
      field-of-view="45deg"
      loading="eager">
    </model-viewer>

    <div class="hint" id="hint">
      <b>التحكم:</b><br>
      <span class="k">يسار</span> تدوير ·
      <span class="k">عجلة</span> تكبير ·
      <span class="k">يمين</span> سحب
      <div class="err" id="err"></div>
    </div>
  </div>

  <div class="footer">
    <div>Digital Twin Viewer — model-viewer</div>
    <div><a id="rawLink" target="_blank">Open model</a></div>
  </div>
</div>

<script>
  const mv = document.getElementById('mv');
  const hudText = document.getElementById('hudText');
  const pbar = document.getElementById('pbar');
  const sub = document.getElementById('sub');
  const err = document.getElementById('err');
  const rawLink = document.getElementById('rawLink');

  const CANDIDATES = ['./Anahcity.glb','./model.glb','./scene.glb'];

  async function exists(url){
    try{ return (await fetch(url,{cache:'no-store'})).ok }
    catch{ return false }
  }

  async function pickModel(){
    for(const u of CANDIDATES) if(await exists(u)) return u;
    return null;
  }

  mv.addEventListener('progress',e=>{
    const pct=Math.round((e.detail.totalProgress||0)*100);
    hudText.textContent=`⏳ Loading… ${pct}%`;
    pbar.style.width=`${pct}%`;
  });

  mv.addEventListener('load',()=>{
    hudText.textContent='✅ Loaded';
    sub.textContent='تم التحميل';
    mv.jumpCameraToGoal();
  });

  (async()=>{
    const m=await pickModel();
    if(!m){ err.style.display='block'; return }
    rawLink.href=m;
    mv.src=m;
  })();
</script>
</body>
</html>
