<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Anah Digital Twin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#f2f2f2;font-family:Arial,sans-serif}
    #hud{position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:9999;
      background:rgba(0,0,0,.78);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;max-width:92vw;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #reset{position:fixed;top:14px;right:14px;z-index:9999;border:0;border-radius:10px;
      background:#0d6efd;color:#fff;padding:10px 14px;cursor:pointer}
    #err{position:fixed;left:14px;right:14px;bottom:14px;z-index:9999;display:none;
      background:rgba(255,255,255,.96);border:1px solid #ddd;border-radius:12px;padding:12px 14px;font-size:13px}
    #err b{color:#b00020}
    code{background:#f3f3f3;padding:2px 4px;border-radius:6px}
  </style>
</head>
<body>
  <div id="hud">‚è≥ Loading‚Ä¶</div>
  <button id="reset">‚ü≥ Reset</button>
  <div id="err"></div>

  <!-- ‚úÖ Use UNPKG (matches examples/js global style) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
  (function(){
    const hud = document.getElementById("hud");
    const errBox = document.getElementById("err");

    function showErr(html){
      errBox.style.display = "block";
      errBox.innerHTML = html;
    }

    window.addEventListener("error", (e) => {
      showErr("<b>JS Error:</b> " + String(e.message || e.error || "Unknown"));
    });

    // ---------- THREE setup ----------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf2f2f2);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // ‚úÖ OrbitControls global (examples/js) => THREE.OrbitControls
    if (!THREE.OrbitControls) {
      showErr("<b>OrbitControls failed to load.</b><br>CDN blocked or file not found.");
      hud.textContent = "‚ùå Controls missing";
      return;
    }
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.maxPolarAngle = Math.PI / 2.05;

    scene.add(new THREE.AmbientLight(0xffffff, 0.75));
    const sun = new THREE.DirectionalLight(0xffffff, 1.25);
    sun.position.set(900, 1100, 700);
    sun.castShadow = true;
    scene.add(sun);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(20000, 20000),
      new THREE.MeshStandardMaterial({ color: 0xdedede })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    let model = null, center = new THREE.Vector3(), size = 1000;

    function setCameraToModel(root){
      const box = new THREE.Box3().setFromObject(root);
      center.copy(box.getCenter(new THREE.Vector3()));
      size = box.getSize(new THREE.Vector3()).length() || 1000;

      controls.target.copy(center);
      camera.position.copy(center).add(new THREE.Vector3(size * 0.6, size * 0.45, size * 0.6));

      camera.near = Math.max(0.01, size / 1000);
      camera.far  = Math.max(5000, size * 10);
      camera.updateProjectionMatrix();
      controls.update();
    }

    document.getElementById("reset").onclick = function(){
      if (!model) return;
      controls.target.copy(center);
      camera.position.copy(center).add(new THREE.Vector3(size * 0.6, size * 0.45, size * 0.6));
      camera.updateProjectionMatrix();
      controls.update();
    };

    window.addEventListener("resize", function(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function bust(url){
      const u = new URL(url, window.location.href);
      u.searchParams.set("v", String(Date.now()));
      return u.toString();
    }

    // ‚úÖ ÿ∂ÿπ ÿßÿ≥ŸÖ ŸÖŸÑŸÅŸÉ ŸáŸÜÿß ÿ®ÿßŸÑÿ∂ÿ®ÿ∑
    const MODEL_FILE = "Anahcity2_0.glb";

    // ÿ¨ÿ±Ÿëÿ® ŸÖÿ≥ÿßÿ±ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©
    const CANDIDATES = [
      "./" + MODEL_FILE,
      "/" + MODEL_FILE,
      "./assets/" + MODEL_FILE,
      "/assets/" + MODEL_FILE,
      "./models/" + MODEL_FILE,
      "/models/" + MODEL_FILE
    ];

    async function headOk(url){
      try{
        const r = await fetch(url, { method:"HEAD", cache:"no-store" });
        return r.ok;
      }catch(_){ return false; }
    }

    async function pickUrl(){
      for (const p of CANDIDATES){
        hud.textContent = "üîé Checking: " + p;
        const u = bust(p);
        if (await headOk(u)) return u;
      }
      return null;
    }

    // ---------- Load model ----------
    if (!THREE.GLTFLoader) {
      showErr("<b>GLTFLoader failed to load.</b>");
      hud.textContent = "‚ùå Loader missing";
      return;
    }
    const loader = new THREE.GLTFLoader();

    async function load(){
      const url = await pickUrl();
      if (!url){
        hud.textContent = "‚ùå Model not found";
        showErr(
          "<b>GLB not found.</b><br>" +
          "ÿ∂ÿπ ÿßŸÑŸÖŸÑŸÅ <code>" + MODEL_FILE + "</code> ŸÅŸä ŸÜŸÅÿ≥ ŸÖÿ¨ŸÑÿØ <code>index.html</code> ÿ£Ÿà ÿØÿßÿÆŸÑ <code>/assets</code> ÿ£Ÿà <code>/models</code>.<br><br>" +
          "Tried:<br><code>" + CANDIDATES.join("</code><br><code>") + "</code>"
        );
        return;
      }

      hud.textContent = "‚è≥ Loading model‚Ä¶";
      loader.load(
        url,
        function(gltf){
          model = gltf.scene;
          model.traverse(function(o){
            if (o && o.isMesh){
              o.castShadow = true;
              o.receiveShadow = true;
            }
          });
          scene.add(model);
          setCameraToModel(model);

          hud.textContent = "‚úÖ Loaded";
          setTimeout(()=> hud.style.display="none", 1200);
          errBox.style.display = "none";
        },
        function(xhr){
          if (xhr && xhr.total){
            const pct = Math.round((xhr.loaded / xhr.total) * 100);
            hud.textContent = "‚è≥ Loading model‚Ä¶ " + pct + "%";
          } else {
            hud.textContent = "‚è≥ Loading model‚Ä¶";
          }
        },
        function(e){
          console.error(e);
          hud.textContent = "‚ùå Failed";
          showErr("<b>GLB load error.</b><br>URL: <code>" + url + "</code><br>ÿßŸÅÿ™ÿ≠ Console Ÿàÿ¥ŸàŸÅ ŸáŸÑ 404/Blocked/CORS.");
        }
      );
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    animate();
    load();
  })();
  </script>
</body>
</html>
