<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<title>Anah Digital Twin â€“ Layers</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet"
  href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" />
<script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

<style>
html, body, #cesiumContainer {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  font-family: system-ui, Arial;
}

.topbar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.6);
  color: #fff;
  padding: 8px 16px;
  border-radius: 10px;
  z-index: 10;
}

.layers-panel {
  position: absolute;
  top: 70px;
  left: 10px;
  width: 260px;
  background: rgba(255,255,255,.95);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  padding: 12px;
  z-index: 10;
  max-height: 75%;
  overflow-y: auto;
}

.layers-panel h3 {
  margin: 0 0 8px;
  font-size: 15px;
  text-align: center;
}

.layer-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  font-size: 14px;
}

.layer-color {
  width: 14px;
  height: 14px;
  border-radius: 4px;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª */
.coord-box {
  position:absolute;
  bottom:15px;
  left:15px;
  background:rgba(0,0,0,0.7);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  z-index:20;
  min-width:260px;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ */
.layers-panel button{
  width:100%;
  margin-bottom:6px;
  padding:6px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#263238;
  color:#fff;
}
.layers-panel button:hover{
  background:#37474f;
}
</style>
</head>

<body>

<div class="topbar">ğŸ™ï¸ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¹Ù†Ù‡ â€“ Anah Digital Twin</div>

<div class="layers-panel" id="layersPanel">
  <h3>Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª</h3>
</div>

<div class="layers-panel" id="measurePanel" style="top:380px">
  <h3>Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
  <button id="btnDistance">ğŸ“ Ù‚ÙŠØ§Ø³ Ù…Ø³Ø§ÙØ©</button>
  <button id="btnArea">ğŸ“ Ù‚ÙŠØ§Ø³ Ù…Ø³Ø§Ø­Ø©</button>
  <button id="btnClear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</button>
</div>

<div id="cesiumContainer"></div>

<div class="coord-box" id="coordBox">ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø©</div>

<script>
/* ================= TOKEN ================= */
Cesium.Ion.defaultAccessToken =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNWMxYmU5Ni0zZWUwLTRkNDctYjdhMC01NWY1M2RiN2U4NTUiLCJpZCI6MzU3NDMyLCJpYXQiOjE3Njc3MTUyNzB9.HBEzgBC5NskreMa2Fr6mb7cZNW74AX6XkYu-IKDw8WQ";

/* ================= VIEWER (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±) ================= */
const viewer = new Cesium.Viewer("cesiumContainer", {
  terrainProvider: new Cesium.EllipsoidTerrainProvider(),
  timeline: false,
  animation: false,
  sceneModePicker: false,
  navigationHelpButton: false,
  baseLayerPicker: true,
  geocoder: true,
  homeButton: true,
  fullscreenButton: true,
  shadows: true
});

viewer.shadows = true;
viewer.scene.shadowMap.enabled = true;
viewer.scene.shadowMap.softShadows = true;
viewer.scene.globe.depthTestAgainstTerrain = true;
viewer.scene.globe.enableLighting = true;

/* âœ… ÙˆÙ‚Øª Ø«Ø§Ø¨Øª (UTC Ø£ÙØ¶Ù„) */
viewer.clock.currentTime = Cesium.JulianDate.fromIso8601("2026-01-16T07:30:00Z");
viewer.clock.multiplier = 0;
viewer.clock.shouldAnimate = false;

/* ================= UI ELEMENTS ================= */
const coordBox = document.getElementById("coordBox");
const panel = document.getElementById("layersPanel");

/* ================= HANDLER ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ================= */
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

/* ================= LAYERS ================= */
const layers = [
  { name: "Residential", color: "#FFF59D", assetId: 4355603 },
  { name: "Commercial", color: "#E53935", assetId: 4355604 },
  { name: "Educational", color: "#1E88E5", assetId: 4355606 },
  { name: "Health", color: "#EC407A", assetId: 4355607 },
  { name: "Industrial", color: "#8E24AA", assetId: 4355612 },
  { name: "Religious", color: "#6D4C41", assetId: 4355610 },
  { name: "Services", color: "#26C6DA", assetId: 4355609 },
  { name: "Tourist", color: "#8D6E63", assetId: 4355611 },
  { name: "GreenArea", color: "#2E7D32", assetId: 4355613 },
  { name: "Public Buildings", color: "#455A64", assetId: 4355599 },
  { name: "3D Houses", color: "#90CAF9", assetId: 4355597 },
  { name: "Vertical Buildings", color: "#B0BEC5", assetId: 4355602 },
  { name: "Roads", color: "#9E9E9E", assetId: 4355615 }
];

const tilesets = {};
(async () => {
  for (const layer of layers) {
    const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(layer.assetId);
    viewer.scene.primitives.add(tileset);
    tileset.show = true;
    tileset.shadows = Cesium.ShadowMode.ENABLED;
    tilesets[layer.name] = tileset;

    const item = document.createElement("div");
    item.className = "layer-item";
    item.innerHTML = `
      <input type="checkbox" checked />
      <div class="layer-color" style="background:${layer.color}"></div>
      <span>${layer.name}</span>
    `;
    item.querySelector("input").addEventListener("change", e => {
      tileset.show = e.target.checked;
    });
    panel.appendChild(item);

    if (layer === layers[0]) {
      await tileset.readyPromise;
      viewer.camera.flyToBoundingSphere(tileset.boundingSphere, { duration: 2.5 });
    }
  }
})();

/* ================= COORDS + MARKER (Ù†Ù‚Ø±Ø© Ø¹Ø§Ø¯ÙŠØ©) ================= */
let lastMarker = null;

function setMarkerAndCoords(cartesian){
  // Marker ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø¢Ø®Ø± Ù†Ù‚Ø·Ø©)
  if (lastMarker) viewer.entities.remove(lastMarker);

  lastMarker = viewer.entities.add({
    position: cartesian,
    point: {
      pixelSize: 10,
      color: Cesium.Color.YELLOW,
      outlineColor: Cesium.Color.BLACK,
      outlineWidth: 2
    }
  });

  const carto = Cesium.Cartographic.fromCartesian(cartesian);
  const lat = Cesium.Math.toDegrees(carto.latitude);
  const lon = Cesium.Math.toDegrees(carto.longitude);
  const utm = latLonToUTM(lat, lon);

  coordBox.innerHTML = `
<b>Lat:</b> ${lat.toFixed(6)}<br>
<b>Lon:</b> ${lon.toFixed(6)}<br>
<b>UTM:</b> Zone ${utm.zone}${utm.hemisphere}<br>
E ${utm.easting.toFixed(2)} m<br>
N ${utm.northing.toFixed(2)} m
`;
}

/* ================= MEASUREMENT MODE ================= */
let measureMode = null; // "line" | "polygon" | null
let activeShapePoints = [];
let activeEntity = null;
let measureEntities = []; // ÙÙ‚Ø· Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª

function clearMeasurements(){
  measureEntities.forEach(e => viewer.entities.remove(e));
  measureEntities = [];
  activeShapePoints = [];
  activeEntity = null;
  measureMode = null;

  // Ù†Ø¹ÙŠØ¯ Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
  bindDefaultClick();
}

function bindDefaultClick(){
  handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
  handler.removeInputAction(Cesium.ScreenSpaceEventType.RIGHT_CLICK);

  handler.setInputAction((click) => {
    const cartesian = viewer.scene.pickPosition(click.position);
    if (!cartesian) return;
    setMarkerAndCoords(cartesian);
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

function bindMeasureClicks(){
  handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
  handler.removeInputAction(Cesium.ScreenSpaceEventType.RIGHT_CLICK);

  handler.setInputAction((click) => {
    const pos = viewer.scene.pickPosition(click.position);
    if (!pos) return;

    // Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª + Ù…Ø§Ø±ÙƒØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³
    setMarkerAndCoords(pos);

    activeShapePoints.push(pos);

    if (activeShapePoints.length === 1) {
      if (measureMode === "line") {
        activeEntity = viewer.entities.add({
          polyline: {
            positions: new Cesium.CallbackProperty(() => activeShapePoints, false),
            width: 3,
            material: Cesium.Color.CYAN
          }
        });
      } else {
        activeEntity = viewer.entities.add({
          polygon: {
            hierarchy: new Cesium.CallbackProperty(
              () => new Cesium.PolygonHierarchy(activeShapePoints), false
            ),
            material: Cesium.Color.CYAN.withAlpha(0.4)
          }
        });
      }
      measureEntities.push(activeEntity);
    }

  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  // Right click: Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø©
  handler.setInputAction(() => {
    if (activeShapePoints.length < (measureMode === "line" ? 2 : 3)) {
      // ØºÙŠØ± ÙƒØ§ÙÙŠ
      return;
    }

    const labelPos = activeShapePoints[activeShapePoints.length - 1];
    const resultText = (measureMode === "line")
      ? (calcDistanceMeters(activeShapePoints) / 1000).toFixed(3) + " ÙƒÙ…"
      : calcAreaSqMeters(activeShapePoints).toFixed(1) + " Ù…Â²";

    const label = viewer.entities.add({
      position: labelPos,
      label: {
        text: resultText,
        font: "14px sans-serif",
        fillColor: Cesium.Color.WHITE,
        showBackground: true,
        backgroundColor: Cesium.Color.BLACK.withAlpha(0.6),
        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        pixelOffset: new Cesium.Cartesian2(0, -12)
      }
    });
    measureEntities.push(label);

    // Ù†ÙˆÙ‚Ù ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆÙ†Ø±Ø¬Ø¹ Ù„Ù„Ù†Ù‚Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    measureMode = null;
    activeShapePoints = [];
    activeEntity = null;
    bindDefaultClick();

  }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ */
document.getElementById("btnDistance").addEventListener("click", () => {
  clearMeasurements();
  measureMode = "line";
  activeShapePoints = [];
  bindMeasureClicks();
});

document.getElementById("btnArea").addEventListener("click", () => {
  clearMeasurements();
  measureMode = "polygon";
  activeShapePoints = [];
  bindMeasureClicks();
});

document.getElementById("btnClear").addEventListener("click", () => {
  clearMeasurements();
});

/* bind default click at start */
bindDefaultClick();

/* ================= UTILS ================= */
function calcDistanceMeters(points){
  let d = 0;
  for(let i=1;i<points.length;i++){
    d += Cesium.Cartesian3.distance(points[i-1], points[i]);
  }
  return d;
}

// Ù…Ø³Ø§Ø­Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¹Ù„Ù‰ WGS84 Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cartographic (Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…)
function calcAreaSqMeters(points){
  // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ lat/lon
  const coords = points.map(p => Cesium.Cartographic.fromCartesian(p));
  let area = 0;
  for (let i = 0; i < coords.length; i++) {
    const p1 = coords[i];
    const p2 = coords[(i + 1) % coords.length];
    area += (p2.longitude - p1.longitude) * (2 + Math.sin(p1.latitude) + Math.sin(p2.latitude));
  }
  area = area * 6378137 * 6378137 / 2;
  return Math.abs(area);
}

/* ===== Lat/Lon â†’ UTM ===== */
function latLonToUTM(lat, lon) {
  const a = 6378137;
  const f = 1 / 298.257223563;
  const k0 = 0.9996;
  const e = Math.sqrt(f * (2 - f));

  const zone = Math.floor((lon + 180) / 6) + 1;
  const lambda0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;

  const phi = lat * Math.PI / 180;
  const lambda = lon * Math.PI / 180;

  const N = a / Math.sqrt(1 - e * e * Math.sin(phi) ** 2);
  const T = Math.tan(phi) ** 2;
  const C = (e * e / (1 - e * e)) * Math.cos(phi) ** 2;
  const A = Math.cos(phi) * (lambda - lambda0);

  const M = a * (
    (1 - e * e / 4 - 3 * e ** 4 / 64 - 5 * e ** 6 / 256) * phi
    - (3 * e * e / 8 + 3 * e ** 4 / 32 + 45 * e ** 6 / 1024) * Math.sin(2 * phi)
    + (15 * e ** 4 / 256 + 45 * e ** 6 / 1024) * Math.sin(4 * phi)
    - (35 * e ** 6 / 3072) * Math.sin(6 * phi)
  );

  let easting = k0 * N * (
    A + (1 - T + C) * A ** 3 / 6 +
    (5 - 18 * T + T ** 2 + 72 * C) * A ** 5 / 120
  ) + 500000;

  let northing = k0 * (
    M + N * Math.tan(phi) * (
      A ** 2 / 2 +
      (5 - T + 9 * C) * A ** 4 / 24 +
      (61 - 58 * T + T ** 2) * A ** 6 / 720
    )
  );

  let hemisphere = "N";
  if (lat < 0) {
    northing += 10000000;
    hemisphere = "S";
  }

  return { zone, hemisphere, easting, northing };
}
</script>

</body>
</html>
