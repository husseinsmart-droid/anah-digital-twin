<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Anah Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#eef1f5; --txt:#0f172a; --muted:#64748b;
      --brand:#1d4ed8; --shadow:0 14px 40px rgba(0,0,0,.12);
    }
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Arial}
    .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;gap:12px;padding:14px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(255,255,255,.8);backdrop-filter:blur(10px);
      border:1px solid rgba(226,232,240,.8);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title b{font-size:14px;color:var(--txt)}
    .title span{font-size:12px;color:var(--muted)}
    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button{
      border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700;
      background:#fff;color:var(--txt);border:1px solid #e2e8f0;
    }
    button.on{background:rgba(29,78,216,.10);border-color:rgba(29,78,216,.35)}
    button.primary{background:var(--brand);color:#fff;border:0;box-shadow:0 10px 26px rgba(29,78,216,.28)}
    .stage{
      position:relative;overflow:hidden;border-radius:18px;border:1px solid rgba(226,232,240,.9);
      background:linear-gradient(180deg,#f8fafc, #eef2ff);
      box-shadow:var(--shadow)
    }
    canvas{display:block;width:100%;height:100%}
    .footer{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;padding:2px 4px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <b>التوأم الرقمي — مدينة عنه</b>
        <span id="sub">تحميل…</span>
      </div>

      <div class="actions">
        <button class="on" id="btnGround">Ground</button>
        <button class="on" id="btnRoads">Roads</button>
        <button class="on" id="btnBuildings">Buildings</button>
        <button class="primary" id="btnReset">⟳ Reset</button>
      </div>
    </div>

    <div class="stage" id="stage"></div>

    <div class="footer">
      <div>Digital Twin Viewer — three.js</div>
      <div>Mouse: Rotate / Wheel: Zoom / Right: Pan</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

    const FILES = {
      ground: "./Ground_0.glb",
      roads: "./Roads_0.glb",
      buildings: "./Buildings_0.glb",
    };

    const stage = document.getElementById("stage");
    const sub = document.getElementById("sub");

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 50000);
    camera.position.set(0, 300, 600);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.screenSpacePanning = true;

    // Light
    const hemi = new THREE.HemisphereLight(0xffffff, 0x334155, 1.0);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.85);
    dir.position.set(300, 600, 200);
    scene.add(dir);

    // Resize
    function resize() {
      const r = stage.getBoundingClientRect();
      renderer.setSize(r.width, r.height, false);
      camera.aspect = r.width / r.height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    const loader = new GLTFLoader();
    const layers = { ground: null, roads: null, buildings: null };

    function loadLayer(key, url) {
      return new Promise((resolve, reject) => {
        loader.load(url, (gltf) => {
          const obj = gltf.scene;
          scene.add(obj);
          layers[key] = obj;
          resolve(obj);
        }, undefined, reject);
      });
    }

    function fitToAll() {
      const box = new THREE.Box3();
      for (const k of Object.keys(layers)) {
        if (layers[k] && layers[k].visible !== false) box.expandByObject(layers[k]);
      }
      if (box.isEmpty()) return;

      const size = new THREE.Vector3();
      const center = new THREE.Vector3();
      box.getSize(size);
      box.getCenter(center);

      controls.target.copy(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const dist = maxDim * 1.2;
      camera.position.set(center.x + dist, center.y + dist * 0.6, center.z + dist);
      camera.near = Math.max(0.1, dist / 1000);
      camera.far = dist * 50;
      camera.updateProjectionMatrix();
      controls.update();
    }

    // UI toggles
    const btnGround = document.getElementById("btnGround");
    const btnRoads = document.getElementById("btnRoads");
    const btnBuildings = document.getElementById("btnBuildings");
    const btnReset = document.getElementById("btnReset");

    function toggle(btn, key) {
      if (!layers[key]) return;
      const on = !(layers[key].visible);
      layers[key].visible = on;
      btn.classList.toggle("on", on);
      fitToAll();
    }

    btnGround.onclick = () => toggle(btnGround, "ground");
    btnRoads.onclick = () => toggle(btnRoads, "roads");
    btnBuildings.onclick = () => toggle(btnBuildings, "buildings");
    btnReset.onclick = () => fitToAll();

    // Load all
    (async () => {
      try {
        sub.textContent = "تحميل الطبقات…";
        await loadLayer("ground", FILES.ground);
        await loadLayer("roads", FILES.roads);
        await loadLayer("buildings", FILES.buildings);

        sub.textContent = "تم التحميل";
        fitToAll();
      } catch (e) {
        console.error(e);
        sub.textContent = "فشل التحميل (تحقق من أسماء الملفات في GitHub)";
      }
    })();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
