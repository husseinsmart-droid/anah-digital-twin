<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Anah Digital Twin — Cesium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CesiumJS (CDN) -->
  <link href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #cesiumContainer { width:100%; height:100%; display:block; }
    .topbar{
      position:fixed; inset:12px 12px auto 12px; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(255,255,255,.85); backdrop-filter: blur(10px);
      border:1px solid rgba(226,232,240,.9); border-radius:14px; padding:10px 12px;
      font-family: system-ui, -apple-system, Segoe UI, Arial;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title b{font-size:14px}
    .title span{font-size:12px;color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700;
      background:#1d4ed8;color:#fff;
    }
    button.ghost{background:#fff;color:#0f172a;border:1px solid #e2e8f0}
    .hint{
      position:fixed; left:12px; bottom:12px; z-index:10;
      background:rgba(255,255,255,.92); border:1px solid rgba(226,232,240,.9);
      border-radius:14px; padding:10px 12px; font-family: system-ui, -apple-system, Segoe UI, Arial;
      box-shadow: 0 14px 40px rgba(0,0,0,.12); font-size:13px;
      max-width:min(560px, calc(100% - 24px));
    }
    .k{display:inline-block;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:2px 8px;margin:2px 4px;font-weight:700}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <b>التوأم الرقمي — مدينة عنه</b>
      <span id="status">تحميل Cesium…</span>
    </div>
    <div class="actions">
      <button class="ghost" id="btnHome">Auto-Fit</button>
      <button id="btnReset">⟳ Reset</button>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <div class="hint">
    <div style="font-weight:800;margin-bottom:4px">التحكم:</div>
    <div>
      <span class="k">يسار ماوس</span> تدوير ·
      <span class="k">يمين ماوس</span> سحب ·
      <span class="k">عجلة</span> تكبير ·
      <span class="k">موبايل</span> سحب/قرص
    </div>
    <div style="margin-top:6px;color:#64748b">
      إذا ما تطابق المكان: عدّل <b>LAT/LON</b> و <b>HEADING_DEG</b> و <b>SCALE</b>.
    </div>
  </div>

  <script>
    // ====== 1) إعدادات مكان نموذجك ======
    // غيّر هذه القيم:
    const MODEL_URL = './Anahcity.glb';   // أو ./Anahcity_0.glb حسب اسم ملفك
    const LAT = 34.37;      // مثال — ضع خط العرض الحقيقي لمركز مشروعك
    const LON = 41.98;      // مثال — ضع خط الطول الحقيقي لمركز مشروعك
    const HEIGHT = 0;       // بالمتر (جرّب 0 أو 5 أو 20 إذا صار تحت الأرض)

    // دوران النموذج (بالدرجات)
    const HEADING_DEG = 0;  // جرّب 0 / 90 / 180 / 270 إذا اتجاهه غلط
    const PITCH_DEG = 0;
    const ROLL_DEG  = 0;

    // مقياس النموذج
    const SCALE = 1.0;      // جرّب 0.5 أو 2.0 حسب وحدات CityEngine

    const statusEl = document.getElementById('status');

    // ====== 2) إنشاء Viewer مع صورة فضائية افتراضية ======
    Cesium.Ion.defaultAccessToken = ""; // (اختياري) إذا عندك Ion token ضعه هنا

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(), // تضاريس عالمية (اختياري)
      timeline: false,
      animation: false,
      homeButton: false,
      geocoder: false,
      sceneModePicker: false,
      navigationHelpButton: false,
      baseLayerPicker: true,   // يخليك تغيّر طبقة الخريطة
      shouldAnimate: false
    });

    // تحسين مظهر
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // ====== 3) إضافة النموذج GLB على إحداثيات حقيقية ======
    const position = Cesium.Cartesian3.fromDegrees(LON, LAT, HEIGHT);

    const hpr = Cesium.HeadingPitchRoll.fromDegrees(HEADING_DEG, PITCH_DEG, ROLL_DEG);
    const orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);

    const entity = viewer.entities.add({
      name: 'Anahcity Model',
      position,
      orientation,
      model: {
        uri: MODEL_URL,
        scale: SCALE,
        minimumPixelSize: 64,
        maximumScale: 2000
      }
    });

    // ====== 4) توجيه الكاميرا للنموذج (Auto-Fit) ======
    async function flyToModel(){
      statusEl.textContent = 'تحميل النموذج…';
      try{
        await viewer.flyTo(entity, {
          duration: 1.2,
          offset: new Cesium.HeadingPitchRange(
            Cesium.Math.toRadians(0),
            Cesium.Math.toRadians(-35),
            1500
          )
        });
        statusEl.textContent = 'تم التحميل';
      }catch(e){
        console.error(e);
        statusEl.textContent = 'فشل تحميل النموذج (تحقق من اسم الملف/المسار)';
      }
    }

    // أزرار
    document.getElementById('btnHome').onclick = flyToModel;
    document.getElementById('btnReset').onclick = () => {
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(LON, LAT, 1800),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-35),
          roll: 0
        }
      });
    };

    // ابدأ
    flyToModel();
  </script>
</body>
</html>
