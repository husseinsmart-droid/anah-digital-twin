<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>التوأم الرقمي — مدينة عنه</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{--bg:#eef1f5;--txt:#0f172a;--muted:#64748b;--brand:#1d4ed8;--shadow:0 14px 40px rgba(0,0,0,.12);}
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Arial}
    .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr;gap:12px;padding:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border:1px solid rgba(226,232,240,.8);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)}
    .title{display:flex;flex-direction:column;gap:2px}
    .title b{font-size:14px;color:var(--txt)}
    .title span{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800;background:#fff;color:var(--txt);border:1px solid #e2e8f0}
    button.secondary{background:#0f172a;color:#fff;border:0}
    .stage{position:relative;overflow:hidden;border-radius:18px;border:1px solid rgba(226,232,240,.9);background:linear-gradient(180deg,#f8fafc,#eef2ff);box-shadow:var(--shadow)}
    model-viewer{width:100%;height:100%;--progress-bar-color: rgba(29,78,216,.95);--poster-color: transparent;}
    .hud{position:absolute;left:50%;top:14px;transform:translateX(-50%);z-index:20;display:flex;align-items:center;gap:10px;background:rgba(0,0,0,.72);color:#fff;padding:10px 12px;border-radius:12px;max-width:92%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bar{width:220px;height:8px;background:rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
    .bar>div{height:100%;width:0%;background:#7dd3fc}
    .err{position:absolute;left:14px;bottom:14px;z-index:25;background:rgba(255,255,255,.95);border:1px solid #fecaca;border-radius:14px;padding:10px 12px;max-width:min(640px, calc(100% - 28px));box-shadow:var(--shadow);display:none}
    .err b{color:#b00020}
    .err code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <b>التوأم الرقمي — مدينة عنه</b>
        <span id="sub">جاهز للتحميل…</span>
      </div>
      <div class="actions">
        <button id="btnAuto">Auto-Fit</button>
        <button class="secondary" id="btnReset">⟳ Reset</button>
      </div>
    </div>

    <div class="stage">
      <div class="hud" id="hud">
        <span id="hudText">⏳ Loading model…</span>
        <div class="bar"><div id="pbar"></div></div>
      </div>

      <model-viewer
        id="mv"
        src=""
        alt="Anah Digital Twin"
        camera-controls
        interaction-prompt="none"
        touch-action="pan-y"
        exposure="1.05"
        shadow-intensity="0.35"
        shadow-softness="0.7"
        environment-image="neutral"
        min-camera-orbit="auto auto 1m"
        max-camera-orbit="auto auto 1500m"
        camera-orbit="45deg 65deg 30m"
        field-of-view="45deg"
        loading="eager"
        reveal="auto">
      </model-viewer>

      <div class="err" id="err"></div>
    </div>
  </div>

<script>
  const mv = document.getElementById('mv');
  const hud = document.getElementById('hud');
  const hudText = document.getElementById('hudText');
  const pbar = document.getElementById('pbar');
  const sub = document.getElementById('sub');
  const err = document.getElementById('err');

  const btnReset = document.getElementById('btnReset');
  const btnAuto  = document.getElementById('btnAuto');

  // جرّب أسماء محتملة + كسر الكاش
  const CANDIDATES = [
    './Anahcity_0.glb',
    './AnahCity_0.glb',
    './anahcity_0.glb',
    './Anahcity.glb'
  ].map(u => u + '?v=' + Date.now());

  function showErr(title, details){
    err.style.display = 'block';
    err.innerHTML = `<b>خطأ:</b> ${title}<br>${details || ''}`;
    hudText.textContent = '❌ Failed';
    sub.textContent = 'فشل التحميل';
    pbar.style.width = '0%';
    hud.style.display = 'flex';
  }

  async function probe(url){
    try{
      const r = await fetch(url, { method:'GET', cache:'no-store' });
      if (!r.ok) return { ok:false, status:r.status, statusText:r.statusText };
      // فحص سريع: إذا كان Git LFS pointer (نص) وليس GLB
      const ct = (r.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('text')) {
        const t = await r.text();
        if (t.includes('git-lfs.github.com/spec')) {
          return { ok:false, status:200, statusText:'Git LFS pointer (not real GLB)' };
        }
      }
      return { ok:true };
    }catch(e){
      return { ok:false, status:0, statusText:String(e) };
    }
  }

  async function pick(){
    for (const u of CANDIDATES){
      const res = await probe(u);
      if (res.ok) return u;
    }
    return null;
  }

  mv.addEventListener('progress', (e) => {
    const p = e.detail?.totalProgress ?? 0;
    const pct = Math.round(p * 100);
    hudText.textContent = `⏳ Loading… ${pct}%`;
    sub.textContent = `تحميل النموذج: ${pct}%`;
    pbar.style.width = pct + '%';
    hud.style.display = 'flex';
  });

  mv.addEventListener('load', () => {
    hudText.textContent = '✅ Loaded';
    sub.textContent = 'تم التحميل';
    pbar.style.width = '100%';
    setTimeout(()=> hud.style.display = 'none', 700);
    err.style.display = 'none';
    mv.cameraOrbit = '45deg 65deg auto';
    mv.fieldOfView = '45deg';
    mv.jumpCameraToGoal();
  });

  mv.addEventListener('error', () => {
    showErr('model-viewer error', 'تعذر قراءة GLB. غالباً 404/اسم خطأ أو Git LFS أو مسار غير صحيح.');
  });

  btnReset.onclick = () => {
    mv.cameraOrbit = '45deg 65deg auto';
    mv.fieldOfView = '45deg';
    mv.jumpCameraToGoal();
  };
  btnAuto.onclick = () => {
    mv.cameraOrbit = '35deg 60deg auto';
    mv.fieldOfView = '40deg';
    mv.jumpCameraToGoal();
  };

  (async()=>{
    const chosen = await pick();
    if (!chosen){
      showErr(
        'GLB not reachable',
        `لم أجد الملف بأي اسم من التالي:<br><code>${CANDIDATES.map(x=>x.split('?')[0]).join('</code>, <code>')}</code><br><br>
         جرّب فتح الرابط مباشرة: <code>/Anahcity_0.glb</code> وتأكد هل يعطي 404 أو Git LFS.`
      );
      return;
    }
    mv.src = chosen;
    hudText.textContent = '⏳ Loading: ' + chosen.split('?')[0].replace('./','');
    sub.textContent = 'تحميل: ' + chosen.split('?')[0].replace('./','');
  })();
</script>
</body>
</html>
