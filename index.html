<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<title>Anah Digital Twin â€“ Layers</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet"
  href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" />
<script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

<style>
html, body, #cesiumContainer {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  font-family: system-ui, Arial;
}

.topbar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.6);
  color: #fff;
  padding: 8px 16px;
  border-radius: 10px;
  z-index: 10;
}

.layers-panel {
  position: absolute;
  top: 70px;
  left: 10px;
  width: 260px;
  background: rgba(255,255,255,.95);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  padding: 12px;
  z-index: 10;
  max-height: 75%;
  overflow-y: auto;
}

.layers-panel h3 {
  margin: 0 0 8px;
  font-size: 15px;
  text-align: center;
}

.layer-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  font-size: 14px;
}

.layer-color {
  width: 14px;
  height: 14px;
  border-radius: 4px;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª */
.coord-box {
  position:absolute;
  bottom:15px;
  left:15px;
  background:rgba(0,0,0,0.7);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  z-index:20;
  min-width:260px;
}
</style>
</head>

<body>

<div class="topbar">
ğŸ™ï¸ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¹Ù†Ù‡ â€“ Anah Digital Twin
</div>

<div class="layers-panel" id="layersPanel">
  <h3>Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª</h3>
</div>

<div id="cesiumContainer"></div>

<div class="coord-box" id="coordBox">
ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø©
</div>

<script>
/* ================= TOKEN ================= */
Cesium.Ion.defaultAccessToken =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNWMxYmU5Ni0zZWUwLTRkNDctYjdhMC01NWY1M2RiN2U4NTUiLCJpZCI6MzU3NDMyLCJpYXQiOjE3Njc3MTUyNzB9.HBEzgBC5NskreMa2Fr6mb7cZNW74AX6XkYu-IKDw8WQ";

/* ================= VIEWER (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±) ================= */
const viewer = new Cesium.Viewer("cesiumContainer", {
  terrainProvider: new Cesium.EllipsoidTerrainProvider(),
  timeline: false,
  animation: false,
  sceneModePicker: false,
  navigationHelpButton: false,
  baseLayerPicker: true,
  geocoder: true,
  homeButton: true,
  fullscreenButton: true,
  shadows: true
});

viewer.shadows = true;
viewer.scene.shadowMap.enabled = true;
viewer.scene.shadowMap.softShadows = true;
viewer.scene.globe.depthTestAgainstTerrain = true;
viewer.scene.globe.enableLighting = true;

viewer.clock.currentTime =
  Cesium.JulianDate.fromIso8601("2026-01-16T10:30:00+03:00");
viewer.clock.multiplier = 0;
viewer.clock.shouldAnimate = false;

/* ================= LAYERS ================= */
const layers = [
  { name: "Residential", color: "#FFF59D", assetId: 4355603 },
  { name: "Commercial", color: "#E53935", assetId: 4355604 },
  { name: "Educational", color: "#1E88E5", assetId: 4355606 },
  { name: "Health", color: "#EC407A", assetId: 4355607 },
  { name: "Industrial", color: "#8E24AA", assetId: 4355612 },
  { name: "Religious", color: "#6D4C41", assetId: 4355610 },
  { name: "Services", color: "#26C6DA", assetId: 4355609 },
  { name: "Tourist", color: "#8D6E63", assetId: 4355611 },
  { name: "GreenArea", color: "#2E7D32", assetId: 4355613 },
  { name: "Public Buildings", color: "#455A64", assetId: 4355599 },
  { name: "3D Houses", color: "#90CAF9", assetId: 4355597 },
  { name: "Vertical Buildings", color: "#B0BEC5", assetId: 4355602 },
  { name: "Roads", color: "#9E9E9E", assetId: 4355615 }
];

const tilesets = {};
const panel = document.getElementById("layersPanel");

(async () => {
  for (const layer of layers) {
    const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(layer.assetId);
    viewer.scene.primitives.add(tileset);
    tileset.show = true;
    tileset.shadows = Cesium.ShadowMode.ENABLED;
    tilesets[layer.name] = tileset;

    const item = document.createElement("div");
    item.className = "layer-item";
    item.innerHTML = `
      <input type="checkbox" checked />
      <div class="layer-color" style="background:${layer.color}"></div>
      <span>${layer.name}</span>
    `;
    item.querySelector("input").addEventListener("change", e => {
      tileset.show = e.target.checked;
    });
    panel.appendChild(item);

    if (layer === layers[0]) {
      await tileset.readyPromise;
      viewer.camera.flyToBoundingSphere(
        tileset.boundingSphere,
        { duration: 2.5 }
      );
    }
  }
})();

/* ================= COORDINATES (Lat/Lon + UTM) ================= */
const coordBox = document.getElementById("coordBox");
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

handler.setInputAction(function (click) {
  const cartesian = viewer.scene.pickPosition(click.position);
  if (!cartesian) return;

  const carto = Cesium.Cartographic.fromCartesian(cartesian);
  const lat = Cesium.Math.toDegrees(carto.latitude);
  const lon = Cesium.Math.toDegrees(carto.longitude);

  const utm = latLonToUTM(lat, lon);

  coordBox.innerHTML = `
<b>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</b><br>
Lat: ${lat.toFixed(6)}<br>
Lon: ${lon.toFixed(6)}<br><br>
<b>UTM</b><br>
Zone: ${utm.zone}${utm.hemisphere}<br>
Easting: ${utm.easting.toFixed(2)} m<br>
Northing: ${utm.northing.toFixed(2)} m
`;
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

/* ===== Lat/Lon â†’ UTM ===== */
function latLonToUTM(lat, lon) {
  const a = 6378137;
  const f = 1 / 298.257223563;
  const k0 = 0.9996;
  const e = Math.sqrt(f * (2 - f));

  const zone = Math.floor((lon + 180) / 6) + 1;
  const lambda0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;

  const phi = lat * Math.PI / 180;
  const lambda = lon * Math.PI / 180;

  const N = a / Math.sqrt(1 - e * e * Math.sin(phi) ** 2);
  const T = Math.tan(phi) ** 2;
  const C = (e * e / (1 - e * e)) * Math.cos(phi) ** 2;
  const A = Math.cos(phi) * (lambda - lambda0);

  const M = a * (
    (1 - e * e / 4 - 3 * e ** 4 / 64 - 5 * e ** 6 / 256) * phi
    - (3 * e * e / 8 + 3 * e ** 4 / 32 + 45 * e ** 6 / 1024) * Math.sin(2 * phi)
    + (15 * e ** 4 / 256 + 45 * e ** 6 / 1024) * Math.sin(4 * phi)
    - (35 * e ** 6 / 3072) * Math.sin(6 * phi)
  );

  let easting = k0 * N * (
    A + (1 - T + C) * A ** 3 / 6 +
    (5 - 18 * T + T ** 2 + 72 * C) * A ** 5 / 120
  ) + 500000;

  let northing = k0 * (
    M + N * Math.tan(phi) * (
      A ** 2 / 2 +
      (5 - T + 9 * C) * A ** 4 / 24 +
      (61 - 58 * T + T ** 2) * A ** 6 / 720
    )
  );

  let hemisphere = "N";
  if (lat < 0) {
    northing += 10000000;
    hemisphere = "S";
  }

  return { zone, hemisphere, easting, northing };
}
</script>

</body>
</html>
