<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<title>Anah Digital Twin â€“ Tools</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet"
  href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" />
<script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

<style>
html, body, #cesiumContainer {
  margin: 0; padding: 0;
  width: 100%; height: 100%;
  font-family: system-ui, Arial;
}

/* ===== Top ===== */
.topbar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.65);
  color: #fff;
  padding: 8px 16px;
  border-radius: 10px;
  z-index: 20;
}

/* ===== Dropdown Panels ===== */
.panel {
  position: absolute;
  top: 70px;
  left: 10px;
  width: 270px;
  background: rgba(255,255,255,.95);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  z-index: 20;
  overflow: hidden;
}

.panel h3 {
  margin: 0;
  padding: 10px;
  background: #263238;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
}

.panel-content {
  padding: 10px;
  display: none;
}

.panel.open .panel-content {
  display: block;
}

/* Buttons */
.panel button {
  width:100%;
  margin-bottom:6px;
  padding:6px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#37474f;
  color:#fff;
}
.panel button:hover {
  background:#455a64;
}

/* Layer item */
.layer-item {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  margin-bottom:4px;
}

/* ===== Info Box ===== */
.info-box {
  position:absolute;
  bottom:15px;
  left:15px;
  min-width:280px;
  background:rgba(0,0,0,.75);
  color:#fff;
  padding:12px;
  border-radius:10px;
  font-size:14px;
  z-index:25;
}
</style>
</head>

<body>

<div class="topbar">ğŸ™ï¸ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¹Ù†Ù‡</div>

<!-- Measurements -->
<div class="panel open" id="measurePanel">
  <h3 onclick="togglePanel('measurePanel')">ğŸ“ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
  <div class="panel-content">
    <button onclick="startDistance()">ğŸ“ Ù‚ÙŠØ§Ø³ Ù…Ø³Ø§ÙØ© (Ù…)</button>
    <button onclick="startArea()">â—¼ï¸ Ù‚ÙŠØ§Ø³ Ù…Ø³Ø§Ø­Ø©</button>
    <button onclick="pickCoordinate()">ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
    <button onclick="clearAll()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
  </div>
</div>

<!-- Layers -->
<div class="panel" id="layersPanel" style="top:250px">
  <h3 onclick="togglePanel('layersPanel')">ğŸ˜ï¸ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª</h3>
  <div class="panel-content" id="layersContent"></div>
</div>

<div id="cesiumContainer"></div>

<div class="info-box" id="infoBox">Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ø«Ù… Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>

<script>
/* ===== Token ===== */
Cesium.Ion.defaultAccessToken = "YOUR_TOKEN";

/* ===== Viewer ===== */
const viewer = new Cesium.Viewer("cesiumContainer", {
  terrainProvider: new Cesium.EllipsoidTerrainProvider(),
  timeline:false,
  animation:false,
  shadows:true
});

viewer.scene.globe.enableLighting = true;

/* ===== UI ===== */
function togglePanel(id){
  document.getElementById(id).classList.toggle("open");
}

/* ===== Layers ===== */
const layers = [
  {name:"Residential", assetId:4355603},
  {name:"Commercial", assetId:4355604},
  {name:"Roads", assetId:4355615}
];

const layersContent = document.getElementById("layersContent");
(async ()=>{
  for(const l of layers){
    const ts = await Cesium.Cesium3DTileset.fromIonAssetId(l.assetId);
    viewer.scene.primitives.add(ts);
    const div = document.createElement("div");
    div.className="layer-item";
    div.innerHTML = `<input type="checkbox" checked> ${l.name}`;
    div.querySelector("input").onchange=e=>ts.show=e.target.checked;
    layersContent.appendChild(div);
  }
})();

/* ===== Tools ===== */
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
const infoBox = document.getElementById("infoBox");

let mode=null;
let points=[];
let entities=[];

function clearAll(){
  entities.forEach(e=>viewer.entities.remove(e));
  entities=[];
  points=[];
  mode=null;
  infoBox.innerHTML="ØªÙ… Ø§Ù„Ù…Ø³Ø­";
  handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

/* ===== Marker Balloon ===== */
function addBalloon(pos){
  const b = viewer.entities.add({
    position: pos,
    billboard:{
      image:"https://cdn-icons-png.flaticon.com/512/684/684908.png",
      verticalOrigin:Cesium.VerticalOrigin.BOTTOM,
      scale:0.07
    }
  });
  entities.push(b);
}

/* ===== Coordinate ===== */
function pickCoordinate(){
  clearAll();
  mode="coord";
  handler.setInputAction(e=>{
    const p = viewer.scene.pickPosition(e.position);
    if(!p) return;
    addBalloon(p);
    const c = Cesium.Cartographic.fromCartesian(p);
    const lat = Cesium.Math.toDegrees(c.latitude);
    const lon = Cesium.Math.toDegrees(c.longitude);
    const utm = latLonToUTM(lat,lon);

    infoBox.innerHTML = `
<b>WGS84</b><br>
N: ${lat.toFixed(6)}<br>
E: ${lon.toFixed(6)}<br><br>
<b>UTM</b><br>
E: ${utm.easting.toFixed(2)} m<br>
N: ${utm.northing.toFixed(2)} m<br>
Zone: ${utm.zone}${utm.hemisphere}
`;
  },Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

/* ===== Distance ===== */
function startDistance(){
  clearAll(); mode="dist";
  handler.setInputAction(e=>{
    const p = viewer.scene.pickPosition(e.position);
    if(!p) return;
    addBalloon(p);
    points.push(p);
    if(points.length>1){
      const d = Cesium.Cartesian3.distance(points.at(-2),points.at(-1));
      infoBox.innerHTML = `ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©: ${d.toFixed(2)} Ù…`;
    }
  },Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

/* ===== Area ===== */
function startArea(){
  clearAll(); mode="area";
  handler.setInputAction(e=>{
    const p = viewer.scene.pickPosition(e.position);
    if(!p) return;
    addBalloon(p);
    points.push(p);
    if(points.length>=3){
      const a = calcArea(points);
      infoBox.innerHTML = `â—¼ï¸ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${a.toFixed(1)} Ù…Â²`;
    }
  },Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

/* ===== Utils ===== */
function calcArea(pts){
  let area=0;
  const c=pts.map(p=>Cesium.Cartographic.fromCartesian(p));
  for(let i=0;i<c.length;i++){
    const j=(i+1)%c.length;
    area += (c[j].longitude-c[i].longitude) *
            (2+Math.sin(c[i].latitude)+Math.sin(c[j].latitude));
  }
  return Math.abs(area*6378137*6378137/2);
}

function latLonToUTM(lat, lon){
  const a=6378137,f=1/298.257223563,k0=0.9996;
  const e=Math.sqrt(f*(2-f));
  const zone=Math.floor((lon+180)/6)+1;
  const phi=lat*Math.PI/180,lam=lon*Math.PI/180;
  const lam0=((zone-1)*6-180+3)*Math.PI/180;
  const N=a/Math.sqrt(1-e*e*Math.sin(phi)**2);
  const T=Math.tan(phi)**2;
  const C=(e*e/(1-e*e))*Math.cos(phi)**2;
  const A=Math.cos(phi)*(lam-lam0);
  const M=a*((1-e*e/4)*phi-(3*e*e/8)*Math.sin(2*phi));
  let E=k0*N*(A+(1-T+C)*A**3/6)+500000;
  let Nn=k0*(M+N*Math.tan(phi)*(A*A/2));
  if(lat<0) Nn+=10000000;
  return {zone, hemisphere:lat>=0?"N":"S", easting:E, northing:Nn};
}
</script>

</body>
</html>
